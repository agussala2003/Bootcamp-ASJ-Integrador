<div class="bg-dark">
  <div *ngIf="userState == true" class="container py-5 p-md-5">
    <!-- Ruteo -->
    <div class="row">
      <div class="row">
        <!-- Breadcrumb -->
        <div class="col-12 col-md-9 d-flex align-items-center">
          <a class="text-light text-decoration-none" routerLink="/ordenes"
            >Ordenes</a
          >
          <i *ngIf="this.datosOrd.id != ''" class="bx bx-chevron-right text-light fs-4"></i>
          <p class="m-0 text-light text-md-nowrap">
            <span *ngIf="this.datosOrd.id != ''"
              >Orden {{ this.datosOrd.id }}</span
            >
          </p>
        </div>
        <!-- Breadcrumb -->
        <div
          class="col-12 col-md-3 d-flex justify-content-start justify-content-md-end my-3"
        >
          <a routerLink="/ordenes" class="btn btn-primary">Volver a la lista</a>
        </div>
      </div>
      <!-- Ruteo -->
      <form #formOrd="ngForm" (ngSubmit)="agregarOrden(formOrd)">
        <div class="row">
          <h4 class="text-light my-2">Datos Ordenes <i (click)="openModal()" data-bs-toggle="modal" data-bs-target="#staticBackdrop" class='bx bx-info-circle text-white ms-2'></i> </h4>
          <div class="col-12 col-md-6">
            <div class="row">
              <div class="col-12 col-md-6 mb-2">
                <label for="orden" class="form-label text-light"
                  >Numero de orden:</label
                >
                <input
                  [disabled]="!flagCode"
                  [(ngModel)]="this.datosOrd.id"
                  required
                  type="text"
                  id="orden"
                  name="orden"
                  placeholder="Ingese su numero de orden"
                  class="form-control"
                  minlength="1"
                  maxlength="12"
                  (keyup)="ordenExists()"
                />
                <div
                  *ngIf="formOrd.controls['orden']?.hasError('required')"
                  class="col-auto"
                >
                  <span class="form-text text-light"
                    >El dato es obligatorio</span
                  >
                </div>
                <div *ngIf="!this.isNumberCode" class="col-auto">
                  <span class="form-text text-light">Debe ser numerico</span>
                </div>
                <div *ngIf="this.isActiveOrden" class="col-auto">
                  <span class="form-text text-light">
                    Ingresa una orden que no exista
                  </span>
                </div>
              </div>
              <div class="col-12 col-md-6 mb-2">
                <label for="seleccCodProv" class="form-label text-light"
                  >Codigo Proveedor:</label
                >
                <select
                  [disabled]="this.isProductsInOrden"
                  [(ngModel)]="this.datosOrd.Proveedor"
                  for="seleccCodProv"
                  class="form-select"
                  name="seleccCodProv"
                  id="seleccCodProv"
                  aria-label="Default select example"
                  (click)="prod = ''"
                  required
                >
                  <option value="" selected disabled>
                    Selecciona un proveedor
                  </option>
                  <option
                    *ngFor="let prov of proveedores"
                    value="{{ prov.RazonSocial }}"
                  >
                    {{ prov.RazonSocial }}
                  </option>
                </select>
                <div
                  *ngIf="formOrd.controls['seleccCodProv']?.hasError('required')"
                  class="col-auto"
                >
                  <span class="form-text text-light"
                    >El dato es obligatorio</span
                  >
                </div>
              </div>
              <div class="col-12 col-md-6 mb-2">
                <label for="emision" class="form-label text-light text-nowrap"
                  >Fecha de emision:</label
                >
                <input
                  [(ngModel)]="this.datosOrd.Emision"
                  min="{{ getFormattedDate(today) }}"
                  required
                  type="date"
                  id="emision"
                  name="emision"
                  placeholder="Ingese fecha de emision"
                  class="form-control"
                />
                <div
                  *ngIf="formOrd.controls['emision']?.hasError('required')"
                  class="col-auto"
                >
                  <span class="form-text text-light"
                    >El dato es obligatorio</span
                  >
                </div>
              </div>
              <div class="col-12 col-md-6 mb-2">
                <label for="entrega" class="form-label text-light text-nowrap"
                  >Fecha de entrega:</label
                >
                <input
                  [(ngModel)]="this.datosOrd.Entrega"
                  required
                  min="{{ getFormattedDate(today) }}"
                  type="date"
                  id="entrega"
                  name="entrega"
                  placeholder="Ingese fecha de entrega"
                  class="form-control"
                />
                <div
                *ngIf="formOrd.controls['entrega']?.hasError('required')"
                class="col-auto"
              >
                <span class="form-text text-light"
                  >El dato es obligatorio</span
                >
              </div>
                <div class="col-auto" *ngIf="validateStringDates(this.datosOrd.Emision,this.datosOrd.Entrega)">
                  <span class="form-text text-light">La fecha de entrega debe ser posterior a la emision</span>
                </div>
              </div>
              <div class="col-12 mb-2">
                <label for="infoRecepcion" class="form-label text-light"
                  >Informacion de recepcion:</label
                >
                <textarea
                  [(ngModel)]="this.datosOrd.InfoRecepcion"
                  required
                  rows="3"
                  type="text"
                  id="infoRecepcion"
                  name="infoRecepcion"
                  placeholder="Ingese informacion de recepcion"
                  class="form-control"
                  minlength="15"
                  maxlength="250"
                ></textarea>
                <div
                *ngIf="formOrd.controls['infoRecepcion']?.hasError('required')"
                class="col-auto"
              >
                <span class="form-text text-light"
                  >El dato es obligatorio</span
                >
              </div>
                <div
                  *ngIf="formOrd.controls['infoRecepcion']?.hasError('minlenght')"
                  class="col-auto"
                >
                  <span class="form-text text-light">Al menos 15 caracteres</span>
                </div>
              </div>
              <div class="col-12 col-md-5 mb-2">
                <label for="seleccCodProd" class="form-label text-light"
                  >Codigo / Sku:</label
                >
                <select
                  (click)="searchProds(this.datosOrd.Proveedor)"
                  [disabled]="this.datosOrd.Proveedor == ''"
                  [(ngModel)]="prod"
                  for="seleccCodProd"
                  name="seleccCodProd"
                  id="seleccCodProd"
                  class="form-select"
                  aria-label="Default select example"
                  required
                >
                  <option value="" selected>Selecciona un Sku</option>
                  <option *ngFor="let prod of productos" value="{{ prod.id }}">
                    {{ prod.Producto + " - " + "$" + prod.Precio }}
                  </option>
                </select>
                <div
                  *ngIf="this.datosOrd.Proveedor == ''"
                  class="col-auto"
                >
                  <span class="form-text text-light"
                    >Debes elegir un proveedor</span
                  >
                </div>
              </div>
              <div class="col-12 col-md-4 mb-2">
                <label for="cantidad" class="form-label text-light"
                  >Cantidad:</label
                >
                <input
                  [(ngModel)]="cant"
                  min="1"
                  required
                  type="number"
                  id="cantidad"
                  name="cantidad"
                  placeholder="Ingese cantidad"
                  class="form-control"
                />
              </div>
              <div class="col-12 col-md-3 mb-2 d-flex justify-content-end">
                <button
                  id="btnaggprod"
                  name="btn"
                  [disabled]="cant == '' || prod == '' || cant == null || prod == null"
                  (click)="agregarProd()"
                  type="button"
                  class="btn btn-primary mt-1 w-100"
                >
                  AÃ±adir
              </button>
              </div>
              <div class="col-12 mt-2">
                <button
                  data-bs-toggle="modal" data-bs-target="#exampleModal" 
                  [disabled]="
                    !formOrd.valid ||
                    !this.isProductsInOrden ||
                    this.isActiveOrden ||
                    !this.isNumberCode ||
                    validateStringDates(this.datosOrd.Emision,this.datosOrd.Entrega)
                  "
                  type="button"
                  class="btn btn-success"
                >
                {{this.flagCode ? 'Agregar' : 'Actualizar'}}
                </button>
              </div>
            </div>
          </div>
          <!-- Mostramos el listado de los productos que se van agregando -->
          <div class="col-12 col-md-6">
            <h4 class="mt-3 text-light text-center">
              {{
                this.datosOrd.Productos.length > 0
                  ? "Productos en la orden"
                  : "No tienes productos en la orden"
              }}
            </h4>
            <div
              class="mt-3"
              *ngIf="this.datosOrd.Productos.length > 0"
            >
              <p
                class="text-light d-flex justify-content-center"
                *ngFor="
                  let productoComp of this.datosOrd.Productos;
                  index as i
                "
              >
                {{
                  productoComp.Nombre +
                    " - " +
                    productoComp.Cantidad +
                    " - $" +
                    productoComp.Subtotal
                }}
                <i
                  (click)="deleteProd(i)"
                  class="ms-3 bx bx-x text-light fs-4"
                ></i>
              </p>
            </div>
            <h5 class="mt-3 text-light text-end">
              Total ${{ this.datosOrd.Total }}
            </h5>
          </div>
          <!-- Mostramos el listado de los productos que se van agregando -->
        </div>
        <!-- Modal -->
        <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h1 class="modal-title fs-5" id="exampleModalLabel">Por seguridad...</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                Deseas {{this.flagCode ? 'agregar' : 'actualizar'}} la orden "{{this.datosOrd.id}}"?
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-primary" data-bs-dismiss="modal">Aceptar</button>
              </div>
            </div>
          </div>
        </div>
        <!-- Modal -->
      </form>
    </div>
    <!-- Verificamos el estado del usuario -->
    <div *ngIf="userState == null" class="container py-5 p-md-5">
      <app-navigation-home></app-navigation-home>
    </div>
    <!-- Verificamos el estado del usuario -->
  </div>
</div>
